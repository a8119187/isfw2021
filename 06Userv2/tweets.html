<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="../jquery.min.js"></script>
    <script type="text/javascript" src="../settings.js"></script>
    <script type="text/javascript" src="../osql.js"></script>

    <script>
        function button1Pressed() {
            doInsert();
            resetInputValue();
        }

        setInterval(doSelect, 2000);
        setInterval(doSelectMyTimeline, 2000);

        $().ready(function () {
            inputUsername();
            doSelect();
            viewTimelineInfo();
            doSelectMyTimeline();
        });

        function getUserInfo() {
            var loginUsername = sessionStorage.getItem("username");
            var loginUserid = sessionStorage.getItem("userid");
            return {"loginUsername" : loginUsername, "loginUserid" : loginUserid};
        }

        function inputUsername(){
            document.getElementById('tf1').value = getUserInfo()["loginUsername"];
        }

        function resetInputValue() {
            document.getElementById('tf2').value = '';
        }

        async function doInsert() {
            var username = document.getElementById('tf1').value;
            var tweet = document.getElementById('tf2').value;
            var sql = `insert into Tweets (name, tweet, time) values("${username}", "${tweet}", now());`;
            var objects = await osql.connect(sql);
            console.log(objects);
            document.getElementById('resultInsert').innerHTML = "tweetしました";
        }

        async function doSelect() {
            var sql = 'select * from Tweets order by time desc limit 20';
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = '';
            html += '<table border="1">';
            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];  // 配列が出る
                html += '<tr>' + '<td>' + object.name + '</td>';
                html += '<td>' + object.tweet + '</td>';
                html += '<td>' + object.time + '</td>';
                html += '<td>' + await toggleFollowButton(object.name) + '</td>';
                html += '</tr>';
            }
            html += '</table>';

            // 差分があればHTMLを更新
            if (diffCheck(html)) {
                document.getElementById('resultView').innerHTML = html;
            }
        }

        function diffCheck(newHtml) {
            var diff = document.getElementById('resultView').innerHTML;
            diff = diff.replace('<tbody>', '').replace('</tbody>', '');
            if (!(diff === newHtml)) {
                console.log('差分あり');
                return true;
            }
            else {
                console.log('差分なし');
            }
        }

        // -----------------------フォロー機能---------------------------------
        async function getTweetInfo(tweetName) {
            var sql = `select Users.id from Tweets inner join Users on Users.name = Tweets.name where Users.name = "${tweetName}";`;
            var objects = await osql.connect(sql);
            console.log(objects[0].id);
            return objects[0].id;
        }

        async function usersCheck(tweetName) {
            var registeredUsers  = false;
            var sql = `select * from Tweets inner join Users on Users.name = Tweets.name where Users.name = "${tweetName}";`;
            var objects = await osql.connect(sql);
            if (objects.length) {
                registeredUsers = true;
            }
            console.log(objects, registeredUsers);
            return registeredUsers;
        }

        async function followCheck(toFollowUsername) {
            var alreadyFollowed  = false;
            var sql = `select * from (Tweets inner join Users on Users.name = Tweets.name) inner join Follows on Follows.toid = Users.id where Tweets.name = "${toFollowUsername}" and Follows.fromid = "${getUserInfo()["loginUserid"]}";`;
            var objects = await osql.connect(sql);
            console.log(objects);
            if (objects.length) {
                alreadyFollowed = true;
            }
            return alreadyFollowed;
        }

        async function toggleFollowButton(objectName) {
            var button = "";
            if (await usersCheck(objectName) === false) {
                button = "未登録";
            }
            else if (await followCheck(objectName)) {
                button = `<button id="${objectName}Button" onclick="pressFollowButton('${objectName}')">フォロー済み</button>`;
            }
            else {
                button = `<button id="${objectName}Button" onclick="pressFollowButton('${objectName}')">フォロー</button>`;
            }
            return button;
        }

        async function pressFollowButton(objectName){
            alreadyFollowed = await followCheck(objectName);
            if (alreadyFollowed) {
                alert("すでにフォローしています");
            }
            else {
                await followUser(objectName);
                // 表の更新（フォローボタンのみ）　execSelect()でもいいけど表全体を読み込み直すのは将来的によくなさそう
                document.getElementById(`${objectName}Button`).outerHTML = await toggleFollowButton(objectName);
            }
        }

        async function followUser(toFollowUsername) {
            // フォロー処理
            if (confirm("ユーザ" + toFollowUsername + "をフォローします")) {
                var sql = `insert into Follows values ('${getUserInfo()["loginUserid"]}', '${await getTweetInfo(toFollowUsername)}');`;
                var objects = await osql.connect(sql);
                console.log(objects);
            }
        }
        // ---------------------------------------------------------------------


        // --------------------------自分のタイムライン----------------------------
        async function doSelectMyTimeline() {
            var sql = `select * from (Tweets inner join Users on Users.name = Tweets.name) inner join Follows on Follows.toid = Users.id where Follows.fromid = '${getUserInfo()["loginUserid"]}' order by time desc;`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = '';
            html += '<table border="1">';
            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];  // 配列が出る
                html += '<tr>' + '<td>' + object.name + '</td>';
                html += '<td>' + object.tweet + '</td>';
                html += '<td>' + object.time + '</td>';
                html += '</tr>';
            }
            html += '</table>';
            document.getElementById('resultMyView').innerHTML = html;
        }

        function viewTimelineInfo() {
            var timelineInfo = getUserInfo()["loginUsername"] + "さんのTL";
            document.getElementById('timelineInfo').innerHTML = timelineInfo;
        }
        // ---------------------------------------------------------------------
    </script>

</head>

<body>
    <h1>Tweets</h1>
    <br>
    名前:<input id="tf1" value="名無し" type="textfield">
    <br>
    tweet:<input id="tf2" type="textfield">
    <button onclick="button1Pressed()">tweet</button>
    <hr>
    <p id="resultInsert"></p>
    <p>全体のTL<p>
    <p id="resultView"></p>
    <br>
    <p id="timelineInfo">XXさんのTL</p>
    <p id="resultMyView">未フォローです。</p>

</body>

</html>